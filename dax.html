<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DAX Schätzspiel</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f1a2b; --accent:#f5b642; --muted:#9fb0c8; --win:#4bb543;
  }
  body{
    margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:linear-gradient(180deg,#061026 0%, #081526 60%); color:#e6f0fb;
    display:flex; align-items:center; justify-content:center; min-height:100vh; padding:24px;
  }
  .wrap{ width:980px; max-width:96%; }
  header{ display:flex; align-items:center; gap:16px; margin-bottom:18px; }
  .logo{
    width:64px; height:64px; border-radius:12px; background:linear-gradient(135deg,#0b2a4a,#052a3f);
    display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--accent);
    box-shadow:0 6px 18px rgba(0,0,0,.5);
  }
  h1{ margin:0; font-size:20px; letter-spacing:.2px; }
  p.lead{ margin:6px 0 0; color:var(--muted); font-size:13px; }

  main{ display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04); padding:18px; border-radius:12px; box-shadow:0 6px 20px rgba(2,8,23,.5);
  }

  .live{
    display:flex; gap:12px; align-items:center; margin-bottom:12px;
  }
  .price{
    font-size:28px; font-weight:700; color:#fff;
  }
  .change{ color:var(--muted); font-size:13px; }

  .players-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
  .player-row{ display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.01); }
  .player-name{ font-weight:600; color:#dff1ff; }
  .player-est{ color:var(--muted); min-width:120px; text-align:right; }

  .podium{
    display:flex; gap:12px; margin-top:16px; align-items:flex-end; justify-content:center;
  }
  .podium .place{
    width:120px; border-radius:10px; padding:12px; text-align:center; color:#071422;
    background:linear-gradient(180deg,#fff,#f0f0f0); box-shadow:0 8px 18px rgba(2,8,23,.25);
  }
  .place.first{ height:160px; background:linear-gradient(180deg,#ffd66b,#ffb84d); }
  .place.second{ height:120px; background:linear-gradient(180deg,#e6e6e6,#bcbcbc); }
  .place.third{ height:100px; background:linear-gradient(180deg,#d4edf0,#9fd7db); }

  .place .rank{ font-size:13px; font-weight:700; color:#072034; }
  .place .who{ font-size:18px; font-weight:800; margin-top:6px; color:#071422; }
  .place .diff{ margin-top:8px; font-size:13px; color:#072034; }

  aside .info{ color:var(--muted); font-size:13px; margin-bottom:10px; }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; }
  .btn{
    background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 12px; border-radius:8px; cursor:pointer;
  }
  .btn.primary{ background:var(--accent); color:#072034; border:none; font-weight:700; }
  footer{ margin-top:14px; color:var(--muted); font-size:12px; text-align:center; }
  .error{ color:#ff7b7b; margin-top:12px; font-weight:600; }
  @media (max-width:880px){
    main{ grid-template-columns:1fr; }
    .podium{ gap:10px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">DAX</div>
      <div>
        <h1>DAX Schätzspiel</h1>
        <p class="lead">Vergleicht drei Schätzungen mit dem aktuellen DAX und kürt Platz 1–3 nach geringster Abweichung.</p>
      </div>
    </header>

    <main>
      <section class="card" id="mainCard" aria-live="polite">
        <div class="live">
          <div>
            <div class="price" id="daxPrice">—</div>
            <div class="change" id="daxChange">lade aktuellen Kurs…</div>
          </div>
        </div>

        <div id="playersContainer">
          <div class="info">Spieler (aus URL-Parametern):</div>
          <div class="players-list" id="playersList"></div>
        </div>

        <div id="resultArea">
          <div class="info" id="resultInfo" style="display:none;">Ergebnis:</div>
          <div class="podium" id="podiumArea" style="display:none;"></div>
          <div class="error" id="errorMsg" style="display:none;"></div>
        </div>
      </section>

      <aside class="card">
        <div class="info">Wie du Parameter übergibst</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.45;">
          Füge der URL Parameter in der Form <code>player1=Name:Estimate</code> hinzu. Beispiel:
          <div style="margin-top:8px;font-family:monospace;background:rgba(0,0,0,0.25);padding:8px;border-radius:6px;color:#eaf6ff">
            ?player1=Stefan:23500&amp;player2=Anna:24000&amp;player3=Max:23850
          </div>
        </div>

        <div style="margin-top:14px;" class="controls">
          <button class="btn" id="btnReload">Neu laden</button>
          <button class="btn primary" id="btnRecalc">Erneut berechnen</button>
        </div>

        <div style="margin-top:12px;" class="info">Hinweis: Der Live-Kurs stammt von Yahoo Finance. Wenn der Abruf fehlschlägt, prüfe deine Verbindung oder teste später erneut.</div>
      </aside>
    </main>

    <footer>
      Ergebnis wird angezeigt, sobald der aktuelle DAX-Kurs verfügbar ist.
    </footer>
  </div>

<script>
/*
  Erwartete URL-Parameter:
  player1=Name:Estimate
  player2=Name:Estimate
  player3=Name:Estimate

  Beispiel:
  ?player1=Stefan:23500&player2=Anna:24000&player3=Max:23850
*/

function parsePlayersFromQuery() {
  const params = new URLSearchParams(window.location.search);
  const players = [];
  for (let i = 1; i <= 10; i++) { // flexibel: aber benutze drei
    const key = 'player' + i;
    if (!params.has(key)) continue;
    const raw = params.get(key);
    if (!raw) continue;
    // Erlaube Format Name:Estimate oder Name=Estimate
    let name = raw;
    let estimate = null;
    if (raw.includes(':')) {
      const idx = raw.indexOf(':');
      name = raw.slice(0, idx);
      estimate = raw.slice(idx + 1);
    } else if (raw.includes('=')) {
      const idx = raw.indexOf('=');
      name = raw.slice(0, idx);
      estimate = raw.slice(idx + 1);
    }
    name = decodeURIComponent(name).trim();
    if (estimate !== null) estimate = decodeURIComponent(estimate).trim();
    if (!estimate) continue;
    // Numeric parsing: remove thousands separators like . or ,
    const normalized = estimate.replace(/\./g,'').replace(/,/g,'.');
    const value = Number(normalized);
    if (!name) continue;
    if (!isFinite(value)) continue;
    players.push({ name, estimate: value });
    if (players.length >= 3) break;
  }
  return players;
}

function renderPlayers(players) {
  const list = document.getElementById('playersList');
  list.innerHTML = '';
  if (!players.length) {
    list.innerHTML = '<div class="player-row"><div class="player-name">Keine Spieler gefunden</div><div class="player-est">Gib URL-Parameter an</div></div>';
    return;
  }
  players.forEach(p => {
    const row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = '<div class="player-name">' + escapeHtml(p.name) + '</div>' +
                    '<div class="player-est">' + formatNumber(p.estimate) + '</div>';
    list.appendChild(row);
  });
}

function formatNumber(n) {
  return n.toLocaleString('de-DE', {maximumFractionDigits: 2});
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

async function fetchDax() {
  // Yahoo Finance quote endpoint for symbol ^GDAXI (DAX)
  const url = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=%5EGDAXI';
  const res = await fetch(url, {cache: "no-store"});
  if (!res.ok) throw new Error('Netzwerkfehler: ' + res.status);
  const json = await res.json();
  const quote = json && json.quoteResponse && json.quoteResponse.result && json.quoteResponse.result[0];
  if (!quote) throw new Error('Keine Kursdaten erhalten');
  // prefer regularMarketPrice, fallback to regularMarketPreviousClose
  const price = Number(quote.regularMarketPrice ?? quote.regularMarketPreviousClose);
  const change = Number(quote.regularMarketChange ?? 0);
  const changePct = Number(quote.regularMarketChangePercent ?? 0);
  if (!isFinite(price)) throw new Error('Ungültiger Kurswert');
  return { price, change, changePct, raw: quote };
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.style.display = 'block';
  el.textContent = msg;
}

function clearError() {
  const el = document.getElementById('errorMsg');
  el.style.display = 'none';
  el.textContent = '';
}

function renderLive(price, change, changePct) {
  const p = document.getElementById('daxPrice');
  const c = document.getElementById('daxChange');
  p.textContent = formatNumber(price);
  const sign = change > 0 ? '+' : '';
  c.textContent = `${sign}${change.toLocaleString('de-DE', {maximumFractionDigits:2})} (${sign}${changePct.toFixed(2)}%)`;
}

function rankPlayers(players, actualPrice) {
  // calculate absolute difference and sort ascending
  const enriched = players.map(p => {
    const diff = Math.abs(p.estimate - actualPrice);
    return Object.assign({}, p, { diff });
  });
  enriched.sort((a,b) => a.diff - b.diff);
  return enriched;
}

function renderPodium(ranked, actualPrice) {
  const podium = document.getElementById('podiumArea');
  podium.innerHTML = '';
  const places = ['second','first','third']; // visually center first (we'll control order)
  // layout order second, first, third to make first appear center and taller
  const top3 = [ranked[1] || null, ranked[0] || null, ranked[2] || null];
  const labels = ['2. Platz','1. Platz','3. Platz'];
  for (let i=0;i<3;i++){
    const who = top3[i];
    const cls = ['second','first','third'][i];
    const container = document.createElement('div');
    container.className = 'place ' + cls;
    if (!who) {
      container.innerHTML = '<div class="rank">' + labels[i] + '</div><div class="who">—</div><div class="diff">—</div>';
    } else {
      container.innerHTML = '<div class="rank">' + labels[i] + '</div>' +
        '<div class="who">' + escapeHtml(who.name) + '</div>' +
        '<div class="diff">Abw.: ' + formatNumber(who.diff) + '</div>';
    }
    podium.appendChild(container);
  }

  // result info
  const info = document.getElementById('resultInfo');
  info.style.display = 'block';
  podium.style.display = 'flex';
}

function computeAndShow(players, actualPrice) {
  clearError();
  if (!players || players.length < 1) {
    showError('Es wurden keine gültigen Spieler-Parameter gefunden. Bitte URL-Parameter prüfen.');
    return;
  }
  renderPlayers(players);
  renderLive(actualPrice, 0, 0);
  const ranked = rankPlayers(players, actualPrice);
  renderPodium(ranked, actualPrice);
}

async function mainFlow() {
  const players = parsePlayersFromQuery();
  renderPlayers(players);
  try {
    const dax = await fetchDax();
    renderLive(dax.price, dax.change, dax.changePct);
    computeAndShow(players, dax.price);
  } catch (err) {
    showError('Fehler beim Laden des DAX: ' + err.message);
    // allow user to still calculate if they provided an explicit "actual" parameter in URL
    const params = new URLSearchParams(window.location.search);
    if (params.has('actual')) {
      const raw = params.get('actual');
      const normalized = raw.replace(/\./g,'').replace(/,/g,'.');
      const val = Number(normalized);
      if (isFinite(val)) {
        document.getElementById('daxPrice').textContent = formatNumber(val);
        document.getElementById('daxChange').textContent = 'Benutzerdefinierter Kurs';
        computeAndShow(players, val);
        return;
      }
    }
  }
}

document.getElementById('btnReload').addEventListener('click', () => location.reload());
document.getElementById('btnRecalc').addEventListener('click', async () => {
  clearError();
  const players = parsePlayersFromQuery();
  renderPlayers(players);
  try {
    const dax = await fetchDax();
    renderLive(dax.price, dax.change, dax.changePct);
    computeAndShow(players, dax.price);
  } catch (err) {
    showError('Fehler beim Neuberechnen: ' + err.message);
  }
});

// Start on load
mainFlow();
</script>
</body>
</html>